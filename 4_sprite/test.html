<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body onload="main()">

Test Website

<canvas id="mycanvas"></canvas>


<script type="text/javascript">

function main() {
	var canvas = document.getElementById("mycanvas");
	canvas.width = 320;
	canvas.height = 240;
	var env = {
		memory: new WebAssembly.Memory({ initial:21 }),
		_abort: function() { console.error("_abort"); }, 
		_grow:  function() { console.error("_grow"); },
		ntstring: function(stringptr) {
			var mem8 = new Uint8Array(this.memory.buffer);
			var s = "";
			for (var i = stringptr; mem8[i] != 0; i++)
				s += String.fromCharCode(mem8[i]);
			return s;
		}
	};
	WebAssembly.instantiateStreaming(fetch("main.wasm"), { env: env })
	.then(obj => {
		obj.env = env;
		window.obj = obj;

		console.log( "test1",  obj.instance.exports.test1() );
		console.log( "getsprite", obj.instance.exports.getsprite(-1) );

		obj.instance.exports.clearrect(-1, 255, 0, 0, 255);
		obj.instance.exports.paint();

		var a = new Uint32Array( obj.env.memory.buffer, obj.instance.exports.getsprite(-1), 2*320*240 );
		console.log(a[0], a[1], a[2].toString(16), a[3].toString(16), a[4], a[5]);

		var b = new Uint8Array( obj.env.memory.buffer, obj.instance.exports.getsprite(-1), (2+320*240)*4 );
		console.log(b[0], b[1], b[2], b[3]);
		console.log(b[4], b[5], b[6], b[7]);
		console.log(b[8], b[9], b[10], b[11]);

		var ctx = canvas.getContext("2d");
		var data = ctx.getImageData(0, 0, 320, 240);
		for (var y=0; y<240; y++)
		for (var x=0; x<320; x++) {
			data.data[(y*320 + x)*4 + 0] = b[(2 + y*320 + x)*4 + 3];
			data.data[(y*320 + x)*4 + 1] = b[(2 + y*320 + x)*4 + 2];
			data.data[(y*320 + x)*4 + 2] = b[(2 + y*320 + x)*4 + 1];
			data.data[(y*320 + x)*4 + 3] = b[(2 + y*320 + x)*4 + 0];
		}
		// data.data.set(a, 2, 320*240);
		ctx.putImageData(data, 0, 0);
	});
}

</script>


<style type="text/css">
#mycanvas {
	border: 1px solid black;
	display: block;
}
</style>


</body>
</html>