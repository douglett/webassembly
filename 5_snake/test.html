<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body onload="main()">

Test Website

<canvas id="mycanvas"></canvas>


<script type="text/javascript">

// VM OS functions
var vmos = {
	canvas: null,
	root: {
		bin: { },
		ps: { }
	},
	flip: function() {
		// *slow* paint function!
		// get memory
		var b = new Uint8Array( obj.env.memory.buffer, obj.instance.exports.getsprite(-1), (4+320*240)*4 );
		// console.log(b[0], b[1], b[2], b[3]);
		// console.log(b[4], b[5], b[6], b[7]);
		// console.log(b[8], b[9], b[10], b[11]);
		// get canvas
		if (!this.canvas) {
			this.canvas = document.getElementById("mycanvas");
			this.canvas.width  = 320;
			this.canvas.height = 240;
		}
		var ctx = this.canvas.getContext("2d");
		var data = ctx.getImageData(0, 0, 320, 240);
		for (var y=0; y<240; y++)
		for (var x=0; x<320; x++) {
			data.data[(y*320 + x)*4 + 0] = b[(4 + y*320 + x)*4 + 3];
			data.data[(y*320 + x)*4 + 1] = b[(4 + y*320 + x)*4 + 2];
			data.data[(y*320 + x)*4 + 2] = b[(4 + y*320 + x)*4 + 1];
			data.data[(y*320 + x)*4 + 3] = b[(4 + y*320 + x)*4 + 0];
		}
		ctx.putImageData(data, 0, 0);
	},
	print: function(str) {
		console.log( str );
	},
	loadbins: function(bins, cb) {
		var count = 0;
		bins.forEach(bin =>
			fetch(bin)
				.then(response => response.arrayBuffer())
				.then(buffer => {
					vmos.root.bin[bin] = new WebAssembly.Module(buffer)
					count++;
					if (count >= bins.length && typeof(cb) === "function")  cb();
				})
			);
	},
	run: function(bin) {
		// get unique id
		var id;
		for (id=1; id<9999; id++)
			if (!vmos.root.ps.hasOwnProperty(""+id))  break;
		id = ""+id;
		// make
		var env = {
			memory: new WebAssembly.Memory({ initial:64 }),
			_abort: function() { console.error("_abort"); }, 
			_grow:  function() { console.error("_grow"); },
			ntstring: function(stringptr) {
				var mem8 = new Uint8Array(env.memory.buffer);
				var s = "";
				for (var i = stringptr; mem8[i] != 0; i++)
					s += String.fromCharCode(mem8[i]);
				return s;
			},
			jputs: function(ptr, type) {
				type = Math.max( 0, Math.min( parseInt(type, 10), 2 ));
				vmos.print( env.ntstring(ptr) );
			}
		};
		var ps = vmos.root.ps[id] = new WebAssembly.Instance( vmos.root.bin["main.wasm"], {env: env} );
		// ps.env = env;
		ps.memory = env.memory;
		ps.exports.main(1, ["main.wasm"]);
	}
};

function main() {	
	// var env = {
	// 	memory: new WebAssembly.Memory({ initial:21 }),
	// 	_abort: function() { console.error("_abort"); }, 
	// 	_grow:  function() { console.error("_grow"); },
	// 	ntstring: function(stringptr) {
	// 		var mem8 = new Uint8Array(this.memory.buffer);
	// 		var s = "";
	// 		for (var i = stringptr; mem8[i] != 0; i++)
	// 			s += String.fromCharCode(mem8[i]);
	// 		return s;
	// 	},
	// 	jputs: function(ptr, type) {
	// 		type = Math.max( 0, Math.min( parseInt(type, 10), 2 ));
	// 		vmos.print( env.ntstring(ptr) );
	// 	}
	// };

	vmos.loadbins([ "main.wasm" ], function() {
		vmos.run();
	});
}

</script>


<style type="text/css">
#mycanvas {
	border: 1px solid black;
	display: block;
	width: 640px;
	height: 480px;
}
</style>


</body>
</html>